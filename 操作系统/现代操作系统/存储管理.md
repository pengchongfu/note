对内存创建抽象模型以及管理内存

## 无存储器抽象

不使用内存抽象的情况下也是可以运行多道程序的

## 一种存储器抽象：地址空间

**同时处于内存** 并且 **不互相影响**，需要解决保护和重定位的问题

### 动态重定位
使用基址寄存器和界限寄存器
- 缺点是每次访问内存都需要进行加法和比较运算

### 交换技术

把一个进程完整调入内存，运行一段时间，然后存回磁盘（周期性唤醒）

空闲空间管理：
- 使用位图的存储管理
- 使用链表的存储管理
    - 每个节点包含：空闲区还是进程的指示标志、起始地址、长度、下一个节点指针
    - 首次适配、下次适配、最佳适配、最差适配、快速适配

### 虚拟内存

如何管理软件的膨胀
- 60年代，把程序分割成多个片段，叫做覆盖。动态换入换出
- 虚拟内存：每个程序拥有自己的地址空间，分割成多块，每一块称作一页或者页面，每一页有连续的地址范围
- 这些页被映射到物理内存中，但并不是所有的页都必须在内存中才能运行程序

#### 分页

虚拟地址不是被直接送到内存总线上，而是被送到内存管理单元（MMU），MMU把虚拟地址映射成物理内存地址

虚拟内存划分页面，物理内存对应的叫页框

当发现页面没有被映射，CPU陷入到操作系统，这个陷阱称为缺页中断

#### 页表

虚拟地址被分为虚拟页号和偏移量，虚拟页号作为页表索引

页表项的结构：
高速缓存禁止位，访问位，修改位，保护位，在/不在位，页框号

页面的磁盘地址等信息有操作系统内部的软件表格保存，不需要硬件处理

虚拟内存是用来创建一个新的抽象概念——地址空间

#### 加速分页过程

- 虚拟地址到物理地址映射必须非常快
- 虚拟地址空间很大，页表也会很大（并且每个进程都会有自己的页表）

转换检测缓冲区（TLB）
大多数程序总是对少量的页面进行多次的访问。
TLB通常在MMU中，包含少量的表项

软件TLB管理

#### 针对大内存的页表

多级页表：
数据段上方，堆栈段下方是大量没有使用的空闲区，不需要页表
顶级页表的表项中含有二级页表的地址或页框号

倒排页表：
实际内存中每一个页框有一个表项，在64位机器中很常见

## 页面置换算法

同样的事情也发生在高速缓存和内存之间

- 最优页面置换算法
    - 提前知道页面还有多少条指令才能执行到
    - 无法实现
- 最近未使用算法（NRU）
    - 设置R和M标志位
    - 淘汰一个没有被访问的已修改页面比淘汰一个被频繁使用的”干净“页面要好
    - 性能不是最好，但是已经够用了
- 先进先出页面置换算法
    - 有可能淘汰掉常用页面，很少使用
- 第二次机会页面置换算法
    - 多给一次机会，重新放回队尾
    - 用来寻找最近的时钟间隔以来从来没有被访问过的页面
    - 如果都访问过，由于放回队尾时会重置R位，因此算法可以结束
- 时钟页面置换算法
    - 用类似时钟的环形链表
- 最近最少使用页面置换算法（LRU）
    - n * n 矩阵实现
- 软件模拟LRU
    - 最不常用算法（NFU）
    - 老化算法，计数器右移，R位加到计数器最左
- 工作集页面置换算法
    - 一个进程正在使用的页面集合称为工作集
    - 每执行几个指令就发生一次缺页中断，称这个程序发生了颠簸
- 工作集时钟页面置换算法

|算法|注释|
|---|---|
|最优算法|不可实现，但是可以用作基准|
|NRU|LRU的很粗糙的近似|
|FIFO算法|可能抛弃重要页面|
|第二次机会算法|比FIFO有很大的改善|
|时钟算法|现实的|
|LRU|很优秀，难以实现|
|NFU|LRU的粗略的近似|
|老化算法|非常近似的LRU的有效算法|
|工作集算法|开销很大|
|工作集时钟算法|好的有效算法|

- 最好的算法是老化算法和工作集时钟算法

## 分页系统中的设计问题

### 局部分配策略与全局分配策略

怎样在相互竞争的进程之中分配内存？
- 局部页面替换：只替换当前进程的页面
- 全局页面替换

### 负载控制

一旦所有进程的组合工作集超过了内存容量，就可能发生颠簸
- 唯一现实的解决方案就是暂时从内存中去掉一些进程

### 页面大小
- 小页面内部碎片少
- 页面小页表越大

### 分离的指令和数据空间
- 某些计算机支持
- 需要链接器协助

### 共享页面

如果支持分离的I空间和D空间，多个进程共享程序文本就很简单。

fork时进程分别拥有自己的页表，但都指向同一个只读的页面集合；
写时触发只读保护，引发操作系统陷阱，生成副本

写时复制，减少复制提高了性能

### 共享库

共享库（动态链接库）

静态链接：浪费磁盘，并且运行时浪费内存

并且，共享库装载时并不是一次性读入内存，根据需要以页面为单位装载

### 内存映射文件

共享库是内存映射文件的一个特例
可用作进程间通信

### 清除策略

分页守护进程：保护一定数目的页框供给 比 使用所有内存并在需要时搜索一个页框有更好的性能
实现：双指针时钟

### 虚拟内存接口
-为了允许共享内存：高带宽的共享成为可能
分布式共享内存

## 有关实现的问题

### 与分页有关的工作
- 进程创建时
- 进程执行时
- 缺页中断时
- 进程终止时

### 缺页中断处理

### 指令备份

### 锁定内存中的页面
DMA往页面传输数据时，页面被换出。
- 锁住页面，保证其不会被移出内存
- 在内核缓冲区中完成所有的IO操作

### 后备存储
使用交换分区换出页面。没有文件系统，消除了将文件偏移转换成块地址的开销

### 策略和机制分离

## 分段
目前讨论的虚拟内存都是一维的，两个或者多个地址空间更好。
每个段构成了一个独立的地址空间。
程序必须提供两部分地址：段号和段内地址

分段与分页结合：MULTICS系统