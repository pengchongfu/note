# 输入输出

## 5.1 I/O 硬件原理

### 5.1.1 I/O设备
块设备和字符设备

### 5.1.2 设备控制器
### 5.1.3 内存映射I/O
通过控制器上的寄存器与CPU通信，许多设备上还有一个操作系统可以读写的数据缓冲区

### 5.1.4 直接存储器读取
CPU需要重复的从控制器的缓冲区中一次一个字节或者字地读取该块的信息
DMA能够独立CPU访问系统总线

CPU比DMA快，并且去掉DMA可以减少嵌入式设备成本

### 5.1.5 重温中断
现代CPU大量地采用流水线并且有时还采用超标量
精确中断和不精确中断

## 5.2 I/O软件原理

### 5.2.1 I/O软件的目标
- 错误处理：控制器，驱动程序可以自行处理（重复操作）
- 同步（即阻塞）和异步（即中断驱动）
- 缓冲，涉及大量复制，影响性能

### 5.2.2 程序控制I/O
- 轮询或者忙等待，只能访问设备获取状态

### 5.2.3 中断驱动I/O
中断发生在每个字符上，浪费时间

### 5.2.4 使用DMA的I/O

## 5.3 I/O软件层次
4层

### 5.3.1 中断处理程序
### 5.3.2 设备驱动程序
MINIX3中，设备驱动程序作为用户进程运行

### 5.3.3 与设备无关的I/O软件
1. 设备驱动程序的统一接口
    - 驱动程序包含一张表：系统调用指向驱动程序的指针
2. 缓冲
    - 每个字符都启动用户进程，不是一个好方案
    - 缓冲区满了？双缓冲
    - 循环缓冲区
3. 错误报告
4. 分配与释放专用设备
5. 与设备无关的块大小

### 5.3.4 用户空间的I/O软件

## 5.4 盘
具体设备

### 5.4.1盘的硬件
- 逻辑块寻址（LBA）：磁盘扇区从0开始编号，不管几何规格
- RAID：不同条带分布在不同磁盘
- RAID0：无冗余
- RAID1：使用多1倍的磁盘
- RAID2：不是工作在条带，工作在字甚至字节上

### 5.4.2 磁盘格式化
- 柱面斜进
- 低级格式化-分区-每个分区高级格式化

### 5.4.3 磁盘臂调度算法
- 寻道时间
- 旋转延迟
- 传输时间

寻道时间是主导
- 先来先服务：寻道时间过长
- 最短寻道：有些请求长时间得不到处理
- 电梯算法：保持一个方向

### 5.5.4 错误处理
控制器或者操作系统重映射扇区

### 5.4.5 稳定存储器
稳定存储器：要么正确的写，要么什么也不做
使用一对完全相同的磁盘

## 5.5 时钟
### 5.5.1 时钟硬件
可编程时钟：计数器为0时触发CPU中断

### 5.5.2 时钟软件
- 维护日时间
- 防止进程运行超时
- CPU记账
- 用户进程的定时器
- 操作系统的监视器
- 剖析、监视统计

### 5.5.3 软定时器
千兆以太网12微秒需要发出一个数据包
- 中断：需要4微秒
- 轮询：等待时间也很长

软定时器：在内核态将要返回用户态时，检查实时时钟了解软定时器是否到期，到期则执行被调度的事件
根据统计，一般进入内核平均进入率在1~2微秒

## 5.6 用户界面：键盘、鼠标和监视器
### 5.6.1 输入软件
### 5.6.2 输出软件
1. 文本窗口
2. X窗口系统
3. GUI
4. 位图
5. 字体

## 5.7 瘦客户机

## 5.8 电源管理
