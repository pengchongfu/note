# 高性能
新浪微博：明星发布微博，如何实现订阅推送？
- 异步推拉结合
- 区分在线用户和不在线用户

## 缓存
- 使用缓存会有数据不一致和脏读问题
- 缓存穿透
    - 例如访问不存在的数据，所有请求都会打到服务器上，简单的方案是缓存空值
- 一致性哈希算法，集群内互不通信所以几乎可以无限伸缩

代码优化：
- 多线程
    - 解决线程安全的主要手段：
        1. 将对象设计为无状态对象
        2. 使用局部对象
        3. 并发访问资源时使用锁
- 资源复用
    - 单例模式
        1. 因为无状态所以可以用单例模式
    - 对象池
        - 连接池和线程池
- 数据结构
- 垃圾回收
    - GC对性能影响较大，可以深入理解然后优化

## 磁盘
- B+树
    - 最多3层，更新一条记录需要5次磁盘读写，3次读索引，1次读记录，1次更新记录
- LSM树
    - 更为契合 nosql 的用途，减少磁盘读写

# 高可用
- 无状态所以可以由负载平衡实现失效转移
- 负载平衡在应用层起到了了高可用的作用
- 服务降级
    - 两种手段：拒绝服务和关闭功能
- 需要保证幂等性
- 失效转移：
    1. 心跳检测
    2. 失败报告（调用方监控）
- 发布服务流程
    1. 批量发布
    2. 关闭负载平衡
    3. 重启新服务（依赖于无状态）
    4. 打开负载平衡

## CAP 原理
- 为了保证高可用，通常牺牲数据一致性
    - 数据强一致
    - 数据用户一致（用户访问时可以校正）
    - 数据最终一致

# 伸缩性

- 应用服务器应该是无状态的
- 负载均衡
    - IP负载均衡，SNAT
    - 数据链路层负载均衡，web服务器IP与负载均衡器相同，数据包通过时修改mac地址为web服务器mac地址
- 分布式缓存
    - 一致性哈希算法：新加入服务器时保证大部分缓存依然能够命中
    - 这个hash环一般用二叉查找树实现，并且：最右边叶子节点和最左边叶子节点相连
    - 通过将一个节点虚拟化为多个虚拟节点解决负载不均衡的问题，一般虚拟化为150个
- 数据存储服务器集群
    1. 关系型数据库
        - 最简单的方案：
        - 读写分离
        - 分库，缺点跨库的表不能 join
        - 使用支持数据分片的数据库
    2. nosql 数据库

# 可扩展
解耦，模块分布式部署之后具体聚合方式主要有分布式消息队列和分布式服务
- 分布式消息队列
    1. 解耦
    2. 削峰
    3. 加快响应速度
- 分布式服务
    - 纵向拆分：微服务
    - 横向拆分：剥离可服用的服务，大中台