## 数据库

数据库保存在数组中，默认16

键值对保存在键空间（一个字典）中
另外一个字典保存了过期时间，称为过期字典

读取键时发现过期会先删除，再执行命令

删除策略
- 定时删除：浪费计算资源，不现实
- 惰性删除：容易内存泄露
- 定期删除：需要确定每次删除的时长和频率

redis的删除策略
- 所有操作都会惰性删除
- 定期遍历数据库，随机删除

持久化生产RDB文件，不会保存过期键

## RDB持久化
两个命令
- 阻塞
- 子进程

## AOF持久化
保存写命令

需要考虑系统内存缓冲区带来的同步问题

文件会越来越大，所以提供了AOF重写功能

重写功能实现：类似RDB，直接读取现有状态

## 事件
-文件事件：IO多路复用程序将队列中的套接字每次一个向文件事件分派器传送
    - 优先处理读

文件事件处理器
- 连接应答处理器：建立连接
- 命令请求处理器：套接字可读时，执行读入操作
- 命令回复处理器：监听可写事件

- 时间事件：定时和周期

实现：将事件放在一个链表中
- serverCron 每秒运行10次

管理调度：等待文件事件 -> 处理文件事件 -> 处理到达的时间事件 -> 开始新的循环
- 同步、有序、原子地执行
- 下次循环再处理或者子进程子线程，减少阻塞时间


## 客户端
client数据结构
- 套接字
- 数据库指针
- 缓冲区：命令回复放在写缓冲区中
- 等等

## 服务器
- 命令执行过程
    - 命令执行完毕之后，发送了消息之后清空缓冲区
- serverCron 函数
    - server结构体中会缓存当前时间，减少系统调用
- 初始化服务器