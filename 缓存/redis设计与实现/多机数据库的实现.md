## 复制
ps：主从数据库

### 旧版实现
1. 同步
    - 生成 RDB，缓存区记录写命令
    - 载入 RDB
    - 执行写命令
2. 命令传播
    - 传播每条写命令

断线重连需要执行 SYNC 命令，太耗费资源

### 新版实现
PSYNC命令
- 完整同步，和SYNC一样
- 部分重同步

部分重同步
- 复制偏移量（其实就是序号）
- 复制积压缓冲区（默认1M）
- 运行ID（服务器启动时生成）

同步完成之后，服务器也作为客户端执行命令传播

## 哨兵

启动之后，主服务器发来从服务器的信息

同一个主服务器也会有其他哨兵

1. 检测主观下线：哨兵向主服务器发消息
2. 检测客观下线：向其他哨兵确认

故障转移
1. 选举领头哨兵，超过半数（raft算法）
2. 选举主服务器：各种优先级判断，比如偏移量
3. 从服务器复制
4. 旧的主服务器变成从服务器

## 集群

### 节点
clusterLink 结构体：保存节点信息
- nodes 字段保存其他节点信息

### 槽指派
集群的整个数据库分为16384个槽
slots属性：长度16384bit的位图

当键所在的槽不属于自己时，回复MOVE命令，客户端重新发送
`CRC16(key) & 16384`

单机模式的redis-cli不会处理MOVE
集群模式只使用0号数据库

### 重新分片
- 单位是槽

### ASK错误
- 重新分片过程中，要是键已经被迁移发送此错误

### 复制与故障转移

### 消息