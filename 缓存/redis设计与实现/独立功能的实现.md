## 发布与订阅
订阅者链表：客户端结构体链表

## 事务
放进事务队列中

WATCH命令：乐观锁
- 实现：每次有修改操作，都会去遍历被watch键所在的map对应键的链表

事务的ACID性质
- 原子性：要不全执行，要不全不执行；区别在于不支持回滚，因为命令出错一般都是编程错误
- 一致性指的是没有包含非法或者无效的数据
- 隔离性：单线程，并且事务期间不会中断
- 耐久性
    - AOF模式下，并且appendfsync为always（每次执行命令调用sync命令）
    - 或者不管什么模式，每个事务最后执行SAVE

## Lua脚本

### 创建并修改 Lua 环境

1. 创建Lua环境
2. 载入函数库
3. 创建 redis 全局表格
4. 替换随机函数
    - 相同的 seed 结果相同
    - 除非显示设置，每次运行初始化为0
5. 创建排序辅助函数
6. 创建错误报告函数
7. 保护全局变量

### 环境协作组件
- 伪客户端
- lua scripts 字典

### EVAL 命令的实现
1. 在 Lua 环境中定义函数
    - 避免污染全局
    - sha1 作为函数名，方便下次执行
2. 将脚本保存到 lua scripts 字典
3. 执行

### EVALSHA 命令的实现
直接在 lua 环境中执行

### 脚本管理命令的实现
- 重建字典、刷新环境
- 判断是否存在
- 加载到字典和环境中
- 超时

### 脚本复制
所有的写操作都会复制给从服务器

执行 EVALSHA 时可能会报错，因为从服务器可能刚开始复制主服务器，而保证传播所有执行过的脚本传到了从服务器太复杂了
scriptcache_list 字典记录了传了哪些脚本给所有从服务器
- 每当有新的从服务器加入会清空

scriptcache_list 没有的话会将 EVALSHA 转换成 EVAL 命令：从 lua scripts 字典中寻找

## 排序

SORT <key> 命令的实现
ALPHA 选项
ASC 选项和 DESC 选项
BY选项

略

## 二进制数组
底层是字符串对象

## 慢查询日志
设定时间，日志最大数量

日志保存在链表中

## 监视器
每次处理请求之前，会将命令发送到监视器链表