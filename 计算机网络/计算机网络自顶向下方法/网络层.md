# 网络层

网络层实现主机到主机的通信

- 转发：分组在单一路由器中从一条入链路到一条出链路的传送
- 路由选择：分组在网络中的路径

## 4.1 概述

路由选择算法决定了插入路由器转发表中的值

因特网的网络层提供了单一的服务：尽力而为服务

## 4.2 虚电路和数据报网络

- 虚电路网络：仅在网络层提供连接服务
- 数据报网络：仅在网络层提供无连接服务

虚电路网络
- 必须在路由器中保持连接状态信息

数据报网络
- 无需建立虚电路
- 对链路层要求很小
- 复杂功能在应用层实现，方便部署

## 4.3 路由器工作原理

1. 输入端口：
- 物理层和链路层处理
- 检查分组版本号、检验和以及寿命字段，重写后两个字段
- 更新用于网络管理的计数器

2. 交换结构

3. 输出端口

4. 路由选择控制平面
- 路由选择算法

## 4.4 因特网中的转发与编址

1. IP协议
2. 路由选择算法
3. 因特网控制报文协议（ICMP）

数据报格式
- 版本、首部长度、数据报长度
- 分片信息
- 寿命、检验和（寿命确保不会在网络中永远循环，因为TTL会变所以检验和需要每次计算）
- 源地址、目的地址

IP数据报分片
链路层帧能承载的最大数据量叫做最大传送单元（MTU）
分片之后在端系统重组
（IPV6废止了分片）

动态主机配置协议（DHCP）
1. DHCP服务器发现：udp 源地址 0.0.0.0 广播 255.255.255.255
2. DHCP服务器提供：子网中可能有多个服务器，供客户端选择
3. DHCP请求
4. DHCP ACK


网络地址转换
- NAT转换表

ICMP
- ICMP报文是承载在IP分组中的
- ICMP报文类型（很有限）

---
- ping: 类型8编码0 回显请求，类型0编码0 回显回答
- traceroute:
    - 不可达UDP报文段
    - TTL依次增加
    - 路由器丢弃并发送ICMP告警报文，类型11编码0，包含了路由器名字和IP
    - 到达目的地发送端口不可达ICMP报文，类型3编码3
---

IPV6
- 扩大地址容量，32比特到128比特,新增任播地址
- 40字节首部，舍弃了许多选项
- 流标签与优先级

废弃的字段
- 分片、重新组装（直接丢弃，给发送方发ICMP分组太大的差错报文）
- 首部检验和
- 选项

## 4.5 路由选择算法

- 全局式路由选择算法：知道网络中每条链路的费用
- 分散式路由选择算法

Dijkstra 算法，最低费用路径

距离向量路由选择算法

AS内部路由选择算法、AS间路由选择算法

## 4.6 因特网中的路由选择

自治系统内部的路由选择：RIP
- 使用跳数作为费用测度
- 通过 udp 在端口 520 发送RIP请求和报文
- 邻居之间

自治系统内部的路由选择：OSPF
- 设想为RIP的后继者
- 核心是一个使用洪泛链路状态信息的链路状态协议和一个Dijkstra最低费用路径算法
- 会向所有其他路由器广播
- 直接由IP承载

自治系统间的路由选择：BGP
- 从相邻AS获得子网可达性信息
- 向本AS所有路由器传播这些可达性信息
- 基于可达性信息和AS策略，决定到达这些子网的好的路由
- TCP连接

## 4.7 广播和多播路由选择



